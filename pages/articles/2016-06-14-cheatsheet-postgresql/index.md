---
title: 'Удобные запросы в PostgreSQL'
path: "/articles/cheatsheets/cheatsheet-postgresql/"
layout: post
category: "SQL, Cheatsheets"
description: "Небольшой мануал по запросам в PostgreSQL для начинающих, а так же для тех, кто не планирует фокусироваться в данной области, но очень хочет развернуть рабочую среду, создать базу данных, экспортировать или импортировать бэкап затратив минимальное количество времени."
shortDescription: "Небольшой мануал по запросам в PostgreSQL для тех, кто хочет загрузить бэкап или создать базу данных."
datePublished: "2016-06-14T18:33:46Z"
dateModified: "2016-06-14T19:53:56Z"
articleSection: "Technical"
articleKeywords: "PostgreSQL, psql, шпаргалка, бэкап"
articleThumbnail: "thumbnail.png"
articleLang: Russian
---

<img alt="PostgreSQL запросы, Elephant by artvandaley" title="Удобные запросы в PostgreSQL" src="./thumbnail.png" width="310" style="margin-left: 20px; margin-right: 20px; float: right;" />

Небольшой мануал по запросам в **PostgreSQL** для начинающих, а так же для тех, кто не планирует фокусироваться в данной области, но очень хочет развернуть рабочую среду, создать базу данных, экспортировать или импортировать данные затратив минимальное количество времени.

## Мотивация
В прошлом году я уже встречался с подобной статьей по MySQL. Но, так как часто работаю с PostgreSQL, пришла мысль: почему бы не написать что-то близкое по теме?

Когда я начинал, всё оказалось разбросанным по разным источникам. И, что бы понять, что к чему, мне пришлось прочитать несколько материалов. Скорее всего, вам уже удалось через это пройти, но если вы натолкнулись на эту статью с первой попытки, то вам повезло, так как здесь есть не только структурированный опыт в удобном для чтения формате, но и ссылки, которым можно доверять.

## Установка и настройка
В зависимости от системы, установка всегда отличается. Я бы не хотел здесь останавливаться, так как это займет слишком много текста и снизит фокусировку на основной теме, поэтому сразу предоставлю авторитетные материалы:

+ Установка PostgreSQL 9.4 на дистрибутивы семейства RedHat -- <a title="Install PostgreSQL 9.4 on Fedora 23/22, CentOS/RHEL/SL 7.2/6.7/5.11" href="http://www.if-not-true-then-false.com/2012/install-postgresql-on-fedora-centos-red-hat-rhel/" target="_blank">Install PostgreSQL 9.4 on Fedora 23/22, CentOS/RHEL/SL 7.2/6.7/5.11</a>, мне эта статья очень помогла.
+ Для остальных дистрибутивов, а так же Mac OS и Windows мануал можно найти на официальном сайте <a title="postgresql.org downloads" href="https://www.postgresql.org/download/" target="_blank">PostgreSQL</a>, он очень удобный.

## PSQL и команды
В этом разделе находятся базовые команды для запуска PSQL, список быстрых и список распространённых команд. Обратите внимание, что все переменные указаны в виде `__переменная__` , их необходимо заменить.

### Соединение
После успешной установки, что бы попасть в консоль, набираем магические слова:
```
psql -U postgres
```
Более расширенный вариант:
```
psql -U __username__ -d __database__ -h __hostname__
```
Не обязательно указывать `__database__` и `__hostname__` так как подключиться всегда можно потом.

### Быстрые команды
Это список быстрых команд, которые легки в запоминании. Большинство из них поддерживают дополнительные параметры и шаблоны поиска.

+ <font color="#d14"> `\q` </font>: Выйти из консоли.
+ <font color="#d14"> `\c __database__` </font>: Подключиться к выбранной базе данных.
+ <font color="#d14"> `\d __table__` </font>: Вывод определенной таблицы, включая тригеры.
+ <font color="#d14"> `\dt *.*` </font>: Вывод таблиц из схем.
+ <font color="#d14"> `\l` </font>: Вывод всех баз данных.
+ <font color="#d14"> `\dn` </font>: Вывод схем.
+ <font color="#d14"> `\df` </font>: Вывод функций.
+ <font color="#d14"> `\dv` </font>: Вывод представлений.
+ <font color="#d14"> `\df+ __function__` </font>: Показать функцию как SQL-код.
+ <font color="#d14"> `\x` </font>: Показать результаты запроса в удобном формате, вместо не очень полезных ASCII-таблиц.

### Распространённые команды
Ниже показан список наиболее распространённых команд, которые можно выполнять под пользователем postgres в последних версиях PostgreSQL.
```
// RedHat, Fedora, CentOS, etc.
su postgres
// Ubuntu, Debian, etc.
sudo postgres
```

В первую очередь это команды для работы с пользователями, бэкапами и данными.

+ <font color="#d14"> `createuser __username__` </font>: добавить нового пользователя. Если хотите создать **суперпользователя**, то просто запустите команду с ключем `-s`.
+ <font color="#d14"> `dropuser __username__` </font>: удалить пользователя.
+ <font color="#d14"> `createdb __database__` </font>: создать новую базу данных.
+ <font color="#d14"> `dropdb __database__` </font>: удалить базу данных.
+ <font color="#d14"> `pg_dump __database__ > __filepath__` </font>: создать **бэкап** указанной базы данных и экспортировать в sql-файл. Возможен запуск с ключами `-a` или `-s`, экспорт только данных или только схем, соответственно.
+ <font color="#d14"> `pg_dumpall > __filepath__` </font>: создать бэкап всех баз данных и экспортировать в один sql-файл.

+ <font color="#d14"> `pg_restore -d __database__ -a __filepath__` </font>:  **восстановить** базу данных из бэкапа. Возможен запуск с ключами `-a` или `-s`, импорт только данных или только схем, соответственно. В текущем случае восстанавливаются только данные.
+ <font color="#d14"> `\copy __table__ TO '__filepath__' CSV` </font>: экспортировать таблицу в **CSV**.
+ <font color="#d14"> `\copy __table__(__column1__,__column2__) TO '__filepath__' CSV` </font>: экспортировать определённые столбцы из таблицы в CSV.
+ <font color="#d14"> `\copy __table__ FROM '__filepath__' CSV` </font>: импортировать CSV в таблицу.
+ <font color="#d14"> `\copy __table__(__column1__,__column2__) FROM '__filepath__' CSV` </font>: импортировать определённые столбцы из CSV в таблицу.
+ <font color="#d14"> `psql -f __filepath__ __database__` </font>: запустить sql-скрипт по отношению к указанной базе данных. Возможен запуск с ключами `-U` -- пользователь, `-d` -- база данных, `-h` -- хост и `-f` -- файл.

## Удобные запросы
Все запросы имеет смысл поделить на три подраздела: работа с пользователями, работа с правами и работа с данными.

### Работа с данными
Создать новую базу данных:
```
CREATE DATABASE __database__ WITH OWNER __username__;
```
Удалить базу данных:
```
DROP DATABASE IF EXISTS __database__;
```
Переименовать базу данных:
```
ALTER DATABASE __oldname__ RENAME TO __newname__;
```

### Работа с пользователями
Получить список всех пользователей:
```
SELECT rolname FROM pg_roles;
```
Создать нового пользователя:
```
CREATE USER __username__ WITH PASSWORD '__password__';
```
Удалить пользователя:
```
DROP USER IF EXISTS __username__;
```
Изменить пароль для пользователя:
```
ALTER ROLE __username__ WITH PASSWORD '__password__';
```

### Работа с правами
Предоставить все права пользователю для указанной базы данных:
```
GRANT ALL PRIVILEGES ON DATABASE __database__ TO __username__;
```
Предоставить права на соединение с базой данных:
```
GRANT CONNECT ON DATABASE __database__ TO __username__;
```
Предоставить права на схемы для пользователя:
```
GRANT USAGE ON SCHEMA public TO __username__;
```
Предоставить права на функции для пользователя:
```
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO __username__;
```
Предоставить права на такие операции, как `SELECT` , `UPDATE` , `INSERT` во всех таблицах текущей базы данных:
```
GRANT SELECT, UPDATE, INSERT ON ALL TABLES IN SCHEMA public TO __username__;
```
Предоставить права на таблицу в текущей базе данных:
```
GRANT SELECT, UPDATE, INSERT ON __table__ TO __username__;
```
Предоставить права на `SELECT` в определенной таблице текущей базы данных:
```
GRANT SELECT ON ALL TABLES IN SCHEMA public TO __username__;
```

## Заключение
PostgreSQL -- пожалуй, один из немногих инструментов, которые актуальны в любое время. Поэтому, всегда имеет смысл обновлять и улучшать статью, что я и собираюсь делать. Но это не означает, что статья будет терять фокусировку, а скорее наоборот.

Кроме этого, вы так же можете принять участие: откройте <a title="create issue on Github" href="https://github.com/wpioneer/blog/issues/new" rel="noindex">Issue</a> на Github, если нашли ошибку или хотите обсудить какие-либо идеи.